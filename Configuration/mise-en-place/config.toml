
[settings]
experimental = true
# lockfile = true
# quiet = true
windows_shim_mode = "symlink"

[tools]
bat = "latest"
# deno = "latest"
eza = "latest"
cargo-binstall = "latest"
"cargo:treefmt" = "latest"
# "cargo:sqruff" = "latest"
# docker-cli = "latest"
# docker-compose = "latest"
# podman = "latest"
# docker-slim = "latest"
jujutsu = "latest"
ripgrep = "latest"
taplo = "latest"
tokei = "latest"
usage = "latest"
# uv = "latest"
watchexec = "latest"
# dust = "latest"
fastfetch = "latest"
cosign = "latest"
# just = "latest"
# typos = "latest"
typst = "latest"
typstyle = "latest"
yamlfmt = "latest"

[env]
PRJ_ROOT = "{{config_root}}"
PRJ_ENV = "{{config_root}}\\environment"
MISE_PROJECT_ROOT = "{{env.PRJ_ROOT}}"
PRJ_NAME = "{{ cwd | basename }}"
DATETIME = "{{ now() | date(format='%Y-%m-%d_%H:%M:%S') }}"
EDITOR = "helix"
PAGER = "bat --color=always --style=plain"

[hooks]
enter = "{{mise_bin}} install --quiet" #TODO: This doesn't seem to do anything
leave = "echo Goodbye!"
postinstall = "mise clean"

[tasks.update]
description = "Update all global tools"
alias = "upd"
run = ["mise self-update", "mise install", "mise upgrade"]

[tasks.clean]
description = "Clean up caches"
alias = "cln"
run = "mise cache prune"

[tasks.info]
description = "Show the information about the project"
alias = "inf"
run = [
  "eza --version",
  "cargo --version",
  "jj --version",
  "rustc --version",
  "tokei --version",
  "treefmt --version",
  "tokei",
  # "{{mise_bin}} files",
]

[tasks.tools]
alias = "reg"
description = "List available tools from the registry filtered by a search term"
usage = '''
arg "pattern" "search pattern to filter tools" default=""
'''
run = "mise registry | rg -- %USAGE_PATTERN%"

[tasks.files]
description = "List the files in the current directory"
alias = "fl"
run = "eza --almost-all --icons=always --long --group-directories-first  --git --git-ignore"

[tasks.tree]
description = "List the files recursively from the current directory"
alias = "ft"
run = "eza --icons --long --group-directories-first --git --tree"

[tasks.lint]
description = "Format the project tree"
alias = "f"
run = [
  "{{mise_bin}} fmt",
  "treefmt --clear-cache --fail-on-change --allow-missing-formatter",
]

[tasks.backup]
description = "Backup the current repo folder to its parent with a timestamp"
alias = "bac"
shell = "powershell"
run = '''
  $timestamp = Get-Date -Format "yyyyMMdd-HHmmss"
  $source = Get-Location
  $parent = Split-Path $source -Parent
  $repoName = Split-Path $source -Leaf
  $destination = Join-Path $parent "$repoName-backup-$timestamp"
  Copy-Item -Path $source -Destination $destination -Recurse -Force
  Write-Output "Backup created at $destination"
'''

[tasks.pujj]
description = "Pull the local jj state with that of the remote origin"
alias = "jj-down"
run = ["jj git fetch --remote origin", "jj rebase --destination main@origin"]

[tasks.pullit]
description = "Fetch and update from remote using Git"
alias = "git-down"
run = ["git checkout main", "git pull origin main"]

[tasks.pull]
description = "Pull the changes to the main branch"
alias = "down"
run = [
  #~@ Fetch and update from remote using Git
  "mise pullit",

  #~@ Sync JJ state with imported Git changes
  "mise pujj",
]

# [tasks.push]
# description = "Push the changes to the main branch"
# alias = "up"
# usage = '''
# arg "allow_backwards" "Allow backwards bookmark movement" default="false"
# arg "force" "Force push even if remote changed" default="false"
# '''
# run = [
#   #~@ Remove JJ lock, if present
#   # "rm -f .jj/working_copy/working_copy.lock 2>/dev/null || true",

#   #~@ Update commit description if needed
#   # "jj describe",

#   #~@ Push with JJ first (for bookmarks, non-protected branches)
#   "jj bookmark set main --revision=@ ${usage_allow_backwards:+--allow-backwards}",
#   "jj git push ${usage_force:+--force}",

#   #~@ Also push latest changes using Git (in case PR workflow is needed)
#   # "git push origin main",
# ]
[tasks.push]
description = "Push the changes to the main branch"
alias = "up"
shell = "powershell"
usage = '''
flag "-b --allow-backwards" help="Allow backwards bookmark movement"
flag "-f --force" help="Force push even if remote changed"
'''
run = '''
  Write-Output "Removing JJ lock if present..."
  Remove-Item -Path .jj/working_copy/working_copy.lock -ErrorAction SilentlyContinue

  Write-Output "Updating commit description..."
  jj describe

  Write-Output "Setting bookmark and pushing..."
  $backwards = if ($env:usage_allow_backwards -eq "true") { "--allow-backwards" } else { "" }
  $backwardsFlag = if ($backwards) { " $backwards" } else { "" }
  Invoke-Expression "jj bookmark set main --revision=@$backwardsFlag"

  $force = if ($env:usage_force -eq "true") { "--force" } else { "" }
  $forceFlag = if ($force) { " $force" } else { "" }
  Invoke-Expression "jj git push$forceFlag"

  Write-Output "Pushing with Git..."
  Invoke-Expression "git push origin main$forceFlag"

  Write-Output "Push complete!"
'''
[tasks.jj_reup]
description = "Pull, backup, and push with allow-backwards"
alias = "reup"
shell = "powershell"
usage = '''
flag "-f --force" help="Force push even if remote changed"
'''
run = '''
mise pull
mise backup
if ($env:usage_force -eq "true") {
  mise push --allow-backwards --force
} else {
  mise push --allow-backwards
}
'''

[tasks.jj]
description = "Initialize the repository to use jusutsu"
alias = "jjinit"
run = ["jj git init --colocate", "jj bookmark track main@origin"]

[tasks.cr]
description = "Run a customizable cargo command, defaults to 'cargo run --quiet'"
shell = "powershell"
run = '''
$command = $env:MISE_TASK_ARGS
if (-not $command) {
    $command = "run --quiet"
}
cargo $command
'''

[tasks.cw]
description = "Run 'cargo watch' with a customizable command, defaults to 'run --quiet'"
shell = "powershell"
run = '''
$command = $env:MISE_TASK_ARGS
if (-not $command) {
    $command = "run --quiet"
}
cargo watch --quiet --clear --exec $command
'''

[tasks.cwc]
description = "Run 'cargo watch' with a customizable command, defaults to 'clippy'"
shell = "powershell"
run = '''
$command = $env:MISE_TASK_ARGS
if (-not $command) {
    $command = "clippy"
}
cargo watch --quiet --clear --exec $command
'''

[tasks.clippy]
description = "Run 'cargo clippy' once and route output to error.txt if there are warnings or errors"
shell = "powershell"
run = '''
$clippyOutput = cargo clippy 2>&1 | Out-String
if ($clippyOutput -match "warning|error") {
    $clippyOutput | Out-File -FilePath error.txt
    Write-Output "Clippy output was not clean. Errors/warnings have been written to error.txt."
} else {
    Write-Output "Clippy output is clean. No errors or warnings."
}
'''

[tasks.ct]
description = "Run 'cargo test' with additional arguments, defaults to '--features quickcheck'"
shell = "powershell"
run = '''
$features = $env:MISE_TASK_ARGS
if (-not $features) {
    $features = "quickcheck"
}
cargo test --features $features
'''

[tasks.cwt]
description = "Run 'cargo watch' with a customizable command, defaults to 'test'"
shell = "powershell"
run = '''
$command = $env:MISE_TASK_ARGS
if (-not $command) {
    $command = "test"
}
cargo watch --quiet --clear --exec test $command
'''

[tasks.cwtq]
description = "Run 'cargo watch' with a customizable command, defaults to 'test with quickcheck'"
shell = "powershell"
run = '''
$command = $env:MISE_TASK_ARGS
if (-not $command) {
    $command = "test  --features quickcheck"
}
cargo watch --quiet --clear --exec $command
'''


[tasks.pulltest]
description = "Test Pull"
alias = "pulltest"
shell = "powershell"
usage = '''
flag "-b --allow-backwards" help="Allow backwards bookmark movement"
flag "-f --force" help="Force push even if remote changed"
'''
run = '''
Write-Output "pulling"
'''
[tasks.bactest]
description = "Test Backup"
shell = "powershell"
usage = '''
flag "-f --force" help="Force push even if remote changed"
'''
run = '''
Write-Output "backingup"
'''
[tasks.pushtest]
description = "Test Push flags (dry run)"
alias = "uptest"
shell = "powershell"
usage = '''
flag "-b --allow-backwards" help="Allow backwards bookmark movement"
flag "-f --force" help="Force push even if remote changed"
'''
run = '''
Write-Output "Would remove JJ lock"
Write-Output "Would run: jj describe"
$backwards = if ($env:usage_allow_backwards -eq "true") { "--allow-backwards" } else { "" }
Write-Output "Would run: jj bookmark set main --revision=@ $backwards"
$force = if ($env:usage_force -eq "true") { "--force" } else { "" }
Write-Output "Would run: jj git push $force"
Write-Output "Would run: git push origin main"
'''
