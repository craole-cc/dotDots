#!/bin/sh

main() {
	initialize_env
	parse_arguments "$@"
	get_path
	build_command
	run_command
}

initialize_env() {
	#| Command Metadata
	_cmd_name="mvp"
	_version="0.2.5"

	#| Defaults (safe baseline)
	path=""
	speed="1"
	resolution="240"
	loop="inf"
	start=""
	stop=""
	last_arg=""
	path_set=""
	loop_opt=""
	speed_opt=""
	start_opt=""
	stop_opt=""
	window_opt=""
	volume=""
	volume_opt=""
	shuffle=""
	pip_mode=""
	verbose=1
	interactive=""

	#| Media file extensions whitelist
	MEDIA_EXTS="mp3 mp4 mkv avi mov flac wav m4a aac ogg opus wma flv webm m4v mpg mpeg 3gp ts m2ts m3u m3u8"

	#| Color helpers
	c_reset=$(printf '\033[0m')
	c_dim=$(printf '\033[2m')
	c_red=$(printf '\033[31m')
	c_green=$(printf '\033[32m')
	c_yellow=$(printf '\033[33m')
	c_blue=$(printf '\033[34m')
	c_magenta=$(printf '\033[35m')
	c_cyan=$(printf '\033[36m')
}

fav() {
	fav="$1"
	case "$fav" in
	--list | list)
		printf "%büéµ Available favorites:%b\n" "$c_cyan" "$c_reset"
		printf "  %bmsj, jackson%b   -> Ms. Jackson\n" "$c_yellow" "$c_reset"
		printf "  %beasier, run%b    -> Easier to Run\n" "$c_yellow" "$c_reset"
		printf "  %bdance%b          -> Dance (URL only)\n" "$c_yellow" "$c_reset"
		printf "  %balive%b          -> Alive (URL only)\n" "$c_yellow" "$c_reset"
		return 0
		;;
	"" | random | --random)
		#> Pick a random name from the known set
		choices="msj easier dance alive linkin losing"
		# shellcheck disable=SC2086
		set -- $choices
		count=$#
		rand=$(od -An -N2 -tu2 /dev/urandom | tr -d ' ')
		pick=$((rand % count + 1))
		fav=$(eval "printf '%s\n' \"\${$pick}\"")
		[ -n "$verbose" ] && printf "%büé≤ Random pick:%b %s\n" "$c_magenta" "$c_reset" "$fav"
		;;
	esac

	case "$fav" in
	ms* | *jack*)
		url="https://youtu.be/kRLj53igKRE"
		local="$HOME/Music/Outkast - Ms. Jackson [Spoofify Cover].mp3"
		artist="Outkast x Spoofify"
		title="Ms. Jackson"
		album="Stankonia"
		start="00:00"
		stop="06:52"
		speed="1.15"
		;;
	eas* | *run)
		url="https://youtu.be/ak826pDzWzo?si=h40VtdCN9SIg6UCt"
		local="$HOME/Music/Linkin Park - Meteora - Part 1 [Spoofify Cover].mp4"
		artist="Linkin Park x Spoofify"
		title="Easier to Run"
		album="Meteora"
		start="14:23"
		stop="19:03"
		speed="1"
		;;
	linkin* | met*)
		url="https://youtu.be/ak826pDzWzo?si=h40VtdCN9SIg6UCt"
		local="$HOME/Music/Linkin Park - Meteora - Part 1 [Spoofify Cover].mp4"
		artist="Linkin Park x Spoofify"
		title="Meteora - Part 1 [Spoofify Cover]"
		album="Meteora"
		;;
	dance)
		url="https://youtu.be/1NBFSPKldgk"
		artist="Whitney Houston x Spoofify"
		title="I Want To Dance With Somebody"
		speed="1.025"
		;;
	alive)
		url="https://youtu.be/YHyVls_FXHA"
		artist="The Bee Gees x Spoofify"
		title="Stayin Alive"
		;;
	losing)
		url="https://youtu.be/OPng7ZooaFc"
		artist="R.E.M x Spoofify"
		title="Losing My Religion"
		speed="1.2"
		;;
	*)
		printf "%b‚ùå Unknown favorite:%b %s\n" "$c_red" "$c_reset" "$fav"
		return 1
		;;
	esac

	#> Normalize/trim
	local=$(trim_string "$local")
	url=$(trim_string "$url")

	#> Prefer local file if it exists and is readable
	if [ -f "$local" ]; then path=$local; else path=$url; fi
}

# Helpers
trim_string() {
	printf "%s" "$*" | awk '{$1=$1;print}'
}

require_arg() {
	[ -z "$2" ] && {
		printf "%b‚ùå Error:%b %s requires a value\n" "$c_red" "$c_reset" "$1"
		print_help
	}
}

print_usage() {
	printf "Usage: %s [OPTIONS] [FILE|FAVORITE]\n\n" "$_cmd_name"
}

#| File type checking helper using whitelist
is_media_file() {
	file="$1"

	# Check if file exists and is readable
	[ ! -f "$file" ] && return 1
	[ ! -r "$file" ] && return 1

	# Get lowercase extension
	ext=$(printf "%s" "$file" | awk -F. '{print tolower($NF)}')

	# Check if extension is in whitelist
	for allowed in $MEDIA_EXTS; do
		if [ "$ext" = "$allowed" ]; then
			return 0
		fi
	done

	return 1
}

#| Get media files from directory (using fd if available)
get_media_files() {
	dir="$1"

	# Check if fd is available
	if command -v fd >/dev/null 2>&1; then
		# Build fd command with extensions
		fd_cmd="fd . \"$dir\" --type f"
		for ext in $MEDIA_EXTS; do
			fd_cmd="$fd_cmd -e $ext"
		done

		# Execute fd command
		eval "$fd_cmd" 2>/dev/null || find "$dir" -type f
	else
		# Fallback to find with grep
		find "$dir" -type f | while read -r file; do
			if is_media_file "$file"; then
				printf "%s\n" "$file"
			fi
		done
	fi
}

get_path() {
	if [ -n "$path_set" ]; then
		: # explicit --path provided
	elif [ -n "$last_arg" ]; then
		case "$last_arg" in
		http://* | https://*)
			path=$last_arg
			;;
		/*)
			if [ -d "$last_arg" ]; then
				handle_directory "$last_arg"
			elif [ -f "$last_arg" ]; then
				path=$last_arg # absolute file
			else
				fav "$last_arg" || return 1
				path=${path:-$url}
				# optionally propagate start/stop/speed:
				start=${start:-$fav_start}
				stop=${stop:-$fav_stop}
				speed=${speed:-$fav_speed}
			fi
			;;
		*)
			if [ -d "$last_arg" ]; then
				handle_directory "$last_arg"
			elif [ -f "$last_arg" ]; then
				path=$last_arg # relative file exists
			else
				fav "$last_arg" || return 1
				path=${path:-$url}
				start=${start:-$fav_start}
				stop=${stop:-$fav_stop}
				speed=${speed:-$fav_speed}
			fi
			;;
		esac
	else
		fav random || return 1
		path=${path:-$url}
		start=${start:-$fav_start}
		stop=${stop:-$fav_stop}
		speed=${speed:-$fav_speed}
	fi
}

handle_directory() {
	dir="$1"
	[ -n "$verbose" ] && printf "%büìÅ Found directory:%b %s\n" "$c_blue" "$c_reset" "$dir"

	# Get list of media files
	media_files=$(get_media_files "$dir")

	# Count files
	media_count=$(printf "%s" "$media_files" | grep -c '^')

	if [ "$media_count" -eq 0 ]; then
		printf "%b‚ùå No media files found in:%b %s\n" "$c_red" "$c_reset" "$dir"
		exit 1
	fi

	# Display found files
	if [ -n "$verbose" ]; then
		printf "%s" "$media_files" | while read -r file; do
			printf "  %b‚úì%b %s\n" "$c_green" "$c_reset" "$(basename "$file")"
		done
	fi

	# Apply shuffle if requested
	if [ -n "$shuffle" ]; then
		media_files=$(printf "%s" "$media_files" | shuf)
		[ -n "$verbose" ] && printf "%büîÄ Shuffled %d files%b\n" "$c_magenta" "$c_reset" "$media_count"
	else
		media_files=$(printf "%s" "$media_files" | sort)
	fi

	# Store as a quoted list of files
	quoted_files=""
	while read -r file; do
		[ -n "$file" ] && quoted_files="$quoted_files \"$file\""
	done <<EOF
$media_files
EOF

	path="$quoted_files"
	[ -n "$verbose" ] && printf "%büìã Found %d media files%b\n" "$c_green" "$c_reset" "$media_count"
}

# Helper to escape single quotes for shell
escape_quotes() {
	printf "%s" "$1" | sed "s/'/'\"'\"'/g"
}

build_command() {
	[ -n "$loop" ] && loop_opt="--loop=$loop"
	[ -n "$speed" ] && speed_opt="--speed=$speed"
	[ -n "$volume" ] && volume_opt="--volume=$volume"
	[ -n "$shuffle" ] && shuffle_opt="--shuffle"
	[ -n "$pip_mode" ] && pip_opt="--ontop --geometry=25%:100%:100%"

	if [ -n "$start" ] && [ -n "$stop" ]; then
		start_opt="--start=$start --ab-loop-a=$start"
		stop_opt="--ab-loop-b=$stop"
	elif [ -n "$start" ]; then
		start_opt="--start=$start"
	fi

	case "$resolution" in
	"") ;;
	0) window_opt="--no-video" ;;
	*) window_opt="--vf=scale=-1:$resolution" ;;
	esac

	# Build metadata options if available
	meta_opt=""
	if [ -n "$artist" ]; then
		meta_msg="Artist: $artist"
		[ -n "$title" ] && meta_msg="${meta_msg}\nTitle: $title"
		[ -n "$album" ] && meta_msg="${meta_msg}\nAlbum: $album"
		# Escape single quotes in metadata
		meta_msg_escaped=$(escape_quotes "$meta_msg")
		meta_opt="--osd-playing-msg-duration=5000 --term-playing-msg=\"$meta_msg_escaped\""
	fi

	audio_opt="--audio-samplerate=48000 --audio-format=s16"

	mpv_opts="$audio_opt $speed_opt $loop_opt $window_opt $start_opt $stop_opt $volume_opt $shuffle_opt $pip_opt $meta_opt"

	# Check if path contains quoted files (from directory)
	if echo "$path" | grep -q '^"' || echo "$path" | grep -q '^ "'; then
		# It's a list of quoted files - use eval expansion
		# Clean up the path variable first
		clean_path=$(echo "$path" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
		mpv_cmd="mpv $mpv_opts $clean_path"
	else
		# It's a single file or URL
		mpv_cmd="mpv \"$path\" $mpv_opts"
	fi

	[ -n "$verbose" ] && print_info
	[ -n "$interactive" ] && show_controls_menu
}

print_info() {
	printf "\n%büé¨ MVPlayer%b " "$c_cyan" "$c_reset"
	printf "%bv%s%b\n\n" "$c_dim" "$_version" "$c_reset"

	[ -n "$artist" ] && printf "   %büé§ Artist:%b %s\n" "$c_dim" "$c_reset" "$artist"
	[ -n "$title" ] && printf "   %büéµ  Title:%b %s\n" "$c_dim" "$c_reset" "$title"
	[ -n "$album" ] && printf "   %büíø  Album:%b %s\n" "$c_dim" "$c_reset" "$album"

	# Show media type
	if echo "$path" | grep -q '^"' || echo "$path" | grep -q '^ "'; then
		# Count quoted files
		file_count=0
		_temp_path="$path"
		while [ -n "$_temp_path" ] && echo "$_temp_path" | grep -q '\"'; do
			_temp_path="${_temp_path#*\"}"
			_temp_path="${_temp_path%%\"*}"
			file_count=$((file_count + 1))
			_temp_path="${_temp_path#* }"
		done
		printf "   %büìã Type:%b    Playlist (%d files)\n" "$c_dim" "$c_reset" "$file_count"
	elif [ -f "$path" ] 2>/dev/null || echo "$path" | grep -q '^https\?://'; then
		clean_path="$path"
		if [ -f "$path" ]; then
			ext=$(printf "%s" "$path" | awk -F. '{print tolower($NF)}')
			case "$ext" in
			mp3 | flac | wav | m4a | aac | ogg | opus | wma | alac | aiff | dsf | dff)
				printf "   %büéµ Type:%b    Audio\n" "$c_dim" "$c_reset"
				;;
			mp4 | mkv | avi | mov | webm | flv | m4v | mpg | mpeg | 3gp | ts | m2ts)
				printf "   %büé• Type:%b    Video\n" "$c_dim" "$c_reset"
				;;
			m3u | m3u8)
				printf "   %büìã Type:%b    Playlist\n" "$c_dim" "$c_reset"
				;;
			esac
		else
			printf "   %büåê Type:%b    URL\n" "$c_dim" "$c_reset"
		fi
	fi

	printf "   %büìÅ   Path:%b  %s\n" "$c_dim" "$c_reset" "$path"
	printf "   %b‚è±Ô∏è   Speed:%b %s\n" "$c_dim" "$c_reset" "${speed:-default}"
	[ -n "$start" ] && printf "   %b‚è∞  Start:%b  %s\n" "$c_dim" "$c_reset" "$start"
	[ -n "$stop" ] && printf "   %b‚èπÔ∏è   Stop:%b   %s\n" "$c_dim" "$c_reset" "$stop"
	printf "   %büîÅ   Loop:%b  %s\n" "$c_dim" "$c_reset" "${loop:-disabled}"
	[ "$resolution" != "240" ] && printf "   %büì∫ Window:%b %s\n" "$c_dim" "$c_reset" "$resolution"
	[ -n "$volume" ] && printf "   %büîä Volume:%b %s\n" "$c_dim" "$c_reset" "$volume"

	printf "\n   %büí° Tip: '?' for shortcuts, 'f' for fullscreen, 'q' to quit%b\n\n" "$c_dim" "$c_reset"
}

run_command() {
	#> Run
	if command -v mpv >/dev/null 2>&1; then
		eval "$mpv_cmd"
	else
		printf "%b‚ö†Ô∏è  mpv not found, attempting nix-shell...%b\n" "$c_yellow" "$c_reset"
		# For nix-shell, we need to pass the command differently
		if echo "$mpv_cmd" | grep -q '^mpv '; then
			# Extract mpv arguments
			mpv_args="${mpv_cmd#mpv }"
			nix-shell -p mpv --run "mpv $mpv_args"
		else
			nix-shell -p mpv --run "$mpv_cmd"
		fi
	fi
}

parse_arguments() {
	while [ $# -gt 0 ]; do
		case "$1" in
		--path | -p)
			require_arg "$@"
			path="$2"
			path_set=1
			shift
			;;
		--speed | -s)
			require_arg "$@"
			speed="$2"
			shift
			;;
		--loop | -l)
			require_arg "$@"
			loop="$2"
			shift
			;;
		--no-loop | -n) loop="" ;;
		--window-size | -w)
			require_arg "$@"
			case "$2" in
			0 | zero | off | none) resolution=0 ;;
			*[!0-9]*)
				printf "%b‚ùå Error:%b --window-size must be numeric\n" "$c_red" "$c_reset"
				exit 1
				;;
			*) resolution="$2" ;;
			esac
			shift
			;;
		--volume | -v)
			require_arg "$@"
			volume="$2"
			shift
			;;
		--pip) pip_mode=1 ;;
		--shuffle) shuffle=1 ;;
		--start)
			require_arg "$@"
			start="$2"
			shift
			;;
		--stop | --end)
			require_arg "$@"
			stop="$2"
			shift
			;;
		-i | --interactive) interactive=1 ;;
		-d | --verbose) verbose=true ;;
		-q | --quiet | --silent) verbose="" ;;
		--version)
			printf "%s v%s\n" "$_cmd_name" "$_version"
			exit 0
			;;
		--help) print_help ;;
		-h) print_usage ;;
		*) last_arg="$1" ;;
		esac
		shift
	done
}

show_controls_menu() {
	printf "\n%büéÆ Interactive Controls:%b\n" "$c_cyan" "$c_reset"
	printf "  %bSpace%b    Pause/Resume\n" "$c_yellow" "$c_reset"
	printf "  %b‚Üê / ‚Üí%b    Seek backward/forward 5s\n" "$c_yellow" "$c_reset"
	printf "  %b‚Üë / ‚Üì%b    Seek backward/forward 60s\n" "$c_yellow" "$c_reset"
	printf "  %b9 / 0%b    Volume down/up\n" "$c_yellow" "$c_reset"
	printf "  %bm%b        Mute/unmute\n" "$c_yellow" "$c_reset"
	printf "  %b[ / ]%b    Decrease/increase speed\n" "$c_yellow" "$c_reset"
	printf "  %bf%b        Toggle fullscreen\n" "$c_yellow" "$c_reset"
	printf "  %bs%b        Take screenshot\n" "$c_yellow" "$c_reset"
	printf "  %bl%b        Toggle A-B loop\n" "$c_yellow" "$c_reset"
	printf "  %bq%b        Quit\n\n" "$c_yellow" "$c_reset"
}

print_help() {
	print_usage
	printf "Options:\n"
	printf "  -p, --path FILE            Path to media file\n"
	printf "  -s, --speed N              Playback speed (0.5-2.0)\n"
	printf "  -l, --loop N|inf           Loop playback N times or infinitely\n"
	printf "  -n, --no-loop              Disable looping\n"
	printf "  -w, --window-size HEIGHT   Scale video window height (0 disables video)\n"
	printf "  -v, --volume N             Set volume (0-100)\n"
	printf "      --pip                  Enable picture-in-picture mode\n"
	printf "      --shuffle              Shuffle playlist (if multiple files)\n"
	printf "      --start TIME           Start playback at TIME (HH:MM:SS)\n"
	printf "      --stop TIME            Stop playback at TIME (HH:MM:SS)\n"
	printf "  -i, --interactive          Show interactive controls menu\n"
	printf "  -d, --verbose              Show debug information\n"
	printf "  -q, --quiet                Suppress output\n"
	printf "  -h, --help                 Show this help message and exit\n"
	printf "      --version              Show version and exit\n\n"
	fav --list

	exit 0
}

main "$@"
