#!/bin/sh

msg="${*:-"Developing flake"}"
path=$(pwd -P)
host=$(hostname)

# Check for nix command
if ! command -v nix >/dev/null 2>&1; then
    printf "âŒ Unable to load REPL: 'nix' not found\n" >&2
    exit 1
fi

# Check for changes
if ! git diff-index --quiet HEAD --; then
    printf "ðŸ“ Adding all changes...\n"
    git add --all || {
        printf "âŒ Failed to add changes\n" >&2
        # Continue even if add fails
    }

    printf "ðŸ’¾ Committing: %s\n" "$msg"
    git commit --message "$msg" || {
        printf "âŒ Failed to commit\n" >&2
        # Continue even if commit fails
    }
else
    printf "ðŸ“Œ No changes to commit\n"
fi

#~@ Functions

load_flake_repl() {
    printf "ðŸ”§ Attempting to load flake REPL for %s...\n" "$host"
    nix repl --extra-experimental-features 'nix-command flakes' "$path#nixosConfigurations.$host"
}

load_default_repl() {
    printf "ðŸ”„ Falling back to default REPL...\n"
    nix repl --file "$path"
}

#~@ Main Logic

if [ -n "$host" ] && [ -f "$path/flake.nix" ]; then
    if ! load_flake_repl; then
        printf "âš ï¸  Failed to load flake REPL, falling back to default...\n" >&2
        load_default_repl || {
            printf "âŒ Failed to load default REPL\n" >&2
            exit 1
        }
    fi
else
    load_default_repl || {
        printf "âŒ Failed to load default REPL\n" >&2
        exit 1
    }
fi
