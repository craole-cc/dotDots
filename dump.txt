{
  host,
  lib,
  # pkgs,
  user,
  ...
}: let
  inherit (lib.attrsets) isAttrs mapAttrs;
  # inherit (lib.lists) findFirst;
  inherit (lib.strings) hasInfix;

  # Centralized mapping configurations
  commandMappings = {
    terminal = {
      foot = "feet";
      ghostty = "ghostty";
    };
    browser = {
      zen-twilight = "zen-twilight";
      zen-beta = "zen-beta";
      # microsoft-edge = "microsoft-edge";
    };
    editor = {
      vscode = "code";
      zed = "zeditor";
    };
    launcher = {
      vicinae = "vicinae toggle";
      fuzzel = "pkill fuzzel || fuzzel --list-executables-in-path";
    };
  };

  classMappings = {
    feet = "foot";
    ghostty = "com.mitchellh.ghostty";
    zeditor = "dev.zed.Zed";
    fuzzel = "fuzzel";
    vicinae = "vicinae";
  };

  # Get command name based on category and name
  getCommand = category: name:
    if commandMappings ? ${category} && commandMappings.${category} ? ${name}
    then commandMappings.${category}.${name}
    else if category == "browser" && hasInfix "zen" name
    then
      if hasInfix "twilight" name
      then "zen-twilight"
      else "zen-beta"
    # else if category == "browser" && hasInfix "edge" name
    # then "microsoft-edge"
    else if category == "editor" && hasInfix "code" name
    then "code"
    else if category == "editor" && hasInfix "zed" name
    then "zeditor"
    else name;

  # Get class name based on command
  getClass = command:
    if classMappings ? ${command}
    then classMappings.${command}
    else if hasInfix "fuzzel" command
    then "fuzzel"
    else if hasInfix "vicinae" command
    then "vicinae"
    else command;

  mkDefault = {
    category,
    option,
    default,
  }: let
    name =
      user.applications.${category}.${option}
      or host.applications.${category}.${option}
      or default;

    command = getCommand category name;
    class = getClass command;
  in {inherit command class;};

  # Simplified category configuration
  mkCategory = category: options:
    mapAttrs (
      name: value:
        mkDefault {
          inherit category;
          option =
            if isAttrs value && value ? option
            then value.option
            else name;
          default =
            if isAttrs value
            then value.default or value
            else value;
        }
    )
    options;

  categoryDefaults = {
    browser = {
      primary = "zen-twilight";
      # secondary = "microsoft-edge";
      secondary = "chromium";
    };
    editor = {
      primary = {
        option = "gui.primary";
        default = "vscode";
      };
      secondary = {
        option = "gui.secondary";
        default = "zed";
      };
    };
    explorer = {
      primary = "yazi";
      secondary = "org.gnome.Nautilus";
    };
    launcher = {
      primary = "vicinae";
      secondary = "fuzzel";
    };
    terminal = {
      primary = "foot";
      secondary = "ghostty";
    };
  };
in {
  _module.args.apps =
    mapAttrs mkCategory categoryDefaults
    // {inherit mkDefault;};

  # home.packages = with pkgs; [
  #   foot
  #   ghostty
  # ];
}
# {lix, ...}: let
#   inherit (lix.filesystem.importers) importAll;
# in {
#   # imports = importAll ./.;
#   # _module.args = {inherit importAll;};
# }
{}
{
  lib,
  user,
  host,
  ...
}: let
  inherit (lib.strings) toUpper;
  fromUser = user.interface.keyboard or {};
  fromHost = host.interface.keyboard or {};
in {
  _module.args.keyboard = {
    mod = toUpper (
      fromUser.modifier or
      fromHost.modifier or
      "Super"
    );
    swapCapsEscape =
      fromUser.swapCapsEscape or
      fromHost.swapCapsEscape or
      null;
    vimKeybinds =
      fromUser.vimKeybinds or
      fromHost.vimKeybinds or
      false;
  };
}
{
  user,
  host,
  ...
}: {
  _module.args.fonts =
    user.interface.style.fonts or host.interface.style.fonts or {
      emoji = "Noto Color Emoji";
      monospace = "Maple Mono NF";
      sans = "Monaspace Radon Frozen";
      serif = "Noto Serif";
      material = "Material Symbols Sharp";
      clock = "Rubik";
    };
}
{host, ...}: let
  locale = host.localization or {};
in {
  _module.args.locale = {
    city = locale.city or "Mandeville, Jamaica";
    timeZone = locale.timeZone or "America/Jamaica";
    defaultLocale = locale.defaultLocale or "en_US.UTF-8";
    locator = locale.locator or "geoclue2";
    latitude = locale.latitude or 18.015;
    longitude = locale.longitude or 77.49;
  };
}
{
  config,
  lix,
  host,
  user,
  paths,
  pkgs,
  ...
}: let
  inherit (lix.filesystem.paths) getDefaults;
  defaults = getDefaults {inherit paths config host user pkgs;};
in {
  _module.args.paths = defaults;
  home = {
    packages = [defaults.wallpapers.manager];
    sessionVariables = {
      # DOTS_WALLPAPER_MANAGER = wallpapers.manager;
      # _DOTS = dots;
      # _API_HOST = api.host;
      # _API_USER = api.user;
    };
  };
}
