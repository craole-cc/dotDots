# shellcheck disable=SC2148,SC2292,SC1090
# ===========================================================================
# DOTS RC - Universal shell configuration loader for DOTS
# Supports: bash, zsh, sh, fish, PowerShell, Nushell
# ===========================================================================

# === NUSHELL ===
# Nushell ignores lines starting with '#' except when they start with '#nu'
#nu if ($env.DOTS == null) {
#nu     print --error "DOTS variable is unset. It must point to the DOTS (dotfiles) directory."
#nu     exit 1
#nu }
#nu
#nu if not ($env.DOTS | path exists) {
#nu     print --error $"Missing DOTS directory: ($env.DOTS)"
#nu     exit 1
#nu }
#nu
#nu let dots_env = ($env.DOTS | path join "Environment" "_.nu")
#nu if not ($dots_env | path exists) {
#nu     print --error $"Missing required configuration module: ($dots_env)"
#nu     exit 1
#nu }
#nu
#nu source $dots_env
#nu exit $env.LAST_EXIT_CODE

# === POSIX SHELLS (bash, zsh, sh) ===
  #{ Validate the DOTS directory
  if [ -z "${DOTS:-}" ]; then
    printf "%s: %s\n%s" \
      "Error: Missing required environment variable" "DOTS" \
      "       It must point to the DOTS (dotfiles) directory path." >&2
    return 2
  elif [ ! -d "${DOTS:-}" ]; then
    printf "ERROR: Invalid DOTS directory: '%s'" "${DOTS:-}" >&2
    return 2
  fi

  #{ Initialize the DOTS scripts
  if [ -d "${DOTS}/Bin" ]; then
    DOTS_BIN="${DOTS}/Bin"
    CMD_BUILDIR="${DOTS_BIN}/shellscript/environment/buildir"

    #{ Build the DOTS_PATH, a colon-delimited string of valid DOTS_BIN directories
    if command -v buildir >/dev/null 2>&1; then
      CMD_BUILDIR="$(command -v buildir)"
      DOTS_PATH="$(buildir --target "${DOTS_BIN}")"
    elif [ -x "${CMD_BUILDIR}" ]; then
      DOTS_PATH="$("${CMD_BUILDIR}" --target "${DOTS_BIN}")"
    elif [ -f "${CMD_BUILDIR:-}" ]; then
      chmod +x "${CMD_BUILDIR}"
      BUILDIR_TARGET="${DOTS_BIN}"
      DOTS_PATH="$(. "${buildir}")"
    fi

    #{ Prepend the DOTS_PATH to the PATH to exsure priority
    if [ -n "${DOTS_PATH:-}" ]; then
      PATH="${DOTS_PATH}:${PATH}"
      export PATH DOTS_PATH DOTS_BIN
    fi
  fi

  #{ Load the DOTS environment
  DOTS_ENV="${DOTS}/Environment" export DOTS_ENV
  if [ -f "${DOTS_ENV}/${RC}.sh" ] ; then
    . "${DOTS_ENV}/${RC}.sh"
  fi

  #{ Exit with the last exit code
  return $?

# === POWERSHELL ===
if (-not $env:DOTS) {
  Throw "DOTS variable is unset. It must point to the DOTS (dotfiles) directory."
}
elseif (-not (Test-Path -Path $env:DOTS -PathType Container)) {
  Throw "Missing DOTS directory: $env:DOTS"
}
else {
  $dotsEnv = Join-Path $env:DOTS 'Environment' '.dotsrc.ps1'
  if (-not (Test-Path -Path $dotsEnv -PathType Leaf)) {
    Throw "Missing required configuration module: ${dotsEnv}"
  }
  else {
    Import-Module $dotsEnv -Force
    return $LASTEXITCODE
  }
}
