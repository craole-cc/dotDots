#!/bin/sh

initialize_cache() {
	CACHE_PATH=.direnv/.path_cache
	CACHE_CHECK=false

	if [ -f "$CACHE_PATH" ]; then
		#> Check if any file in Bin is newer than cache
		if ! find Bin -type f -newer "$CACHE_PATH" 2>/dev/null | read -r _; then
			CACHE_CHECK=true
		fi
	fi

	#> Create the cache if it doesn't exist
	case "${CACHE_CHECK:-false}" in false)
		mkdir -p .direnv
		make_scripts_executable
		initialize_bin >"$CACHE_PATH"
		;;
	*) ;; esac

	. "$CACHE_PATH"
}

#> Ensure scripts in Bin are executable
make_scripts_executable() {
	printf "Making scripts executable...\n" >&2
	changed_count=0

	find Bin -type f 2>/dev/null | while read -r file; do
		#> Skip files with blacklisted extensions
		case "$file" in
		*.md | *.txt | *.json | *.yaml | *.yml | *.xml | *.html | *.css | *.js | *.ts | *.jsx | *.tsx | *.png | *.jpg | *.jpeg | *.gif | *.svg | *.pdf | *.doc | *.docx | *.xls | *.xlsx | *.ppt | *.pptx | *.zip | *.tar | *.gz | *.bz2 | *.7z | *.log)
			continue
			;;
		esac

		#> Fast shebang check using dd
		if dd if="$file" bs=1 count=2 2>/dev/null | grep -q "#!"; then
			#> Check if already executable (POSIX test)
			if [ ! -x "$file" ]; then
				if chmod +x "$file" 2>/dev/null; then
					printf "  +x %s\n" "$file" >&2
					changed_count=$((changed_count + 1))
				fi
			fi
		fi
	done

	if [ "$changed_count" -gt 0 ]; then
		printf "Made %s scripts executable\n" "$changed_count" >&2
	else
		printf "All scripts already executable\n" >&2
	fi
}

#> Ensure Bin scripts are available within the dev shell
initialize_bin() {
	#> Define configuration
	BIN_ROOT="Bin"
	BIN_DEPTH=10
	BIN_IGNORE="review tmp archive"
	DOTS_PATH=""
	dir_count=0

	#> Filter binary directories
	if command -v fd >/dev/null 2>&1; then
		#> Build fd command with multiple --exclude flags dynamically
		fd_cmd="fd --type d --max-depth $((BIN_DEPTH * 2)) . ${BIN_ROOT}"
		for dir in ${BIN_IGNORE}; do
			fd_cmd="${fd_cmd} --exclude ${dir}"
		done
		BIN_DIRS=$(eval "${fd_cmd}")
	else
		#> Fallback to find with grep
		BIN_IGNORE_PATTERN=$(printf "%s" "${BIN_IGNORE}" | tr ' ' '|')
		BIN_DIRS="$(find "${BIN_ROOT}" -maxdepth "${BIN_DEPTH}" -type d |
			grep -v -E "/(${BIN_IGNORE_PATTERN})$")"
	fi

	#> Add all matching directories to PATH
	for dir in ${BIN_DIRS:-}; do
		#> Skip if directory doesn't exist.
		[ -d "${dir}" ] || continue

		#> Skip if already in PATH
		case ":${PATH}:${DOTS_PATH}:" in ":${dir}:") ;; *)
			# PATH_add "$dir"
			DOTS_PATH="${DOTS_PATH:+"${DOTS_PATH}:"}${dir}"
			dir_count=$((dir_count + 1))
			;;
		esac
	done

	if [ -n "${DOTS_PATH:-}" ]; then
		#> Update PATH and export it for cache
		PATH="${DOTS_PATH}:${PATH}"
		export PATH
		#> Output shell commands for cache
		printf "PATH='%s'\n" "${PATH}"
		printf "export PATH\n"
		printf "echo 'Added %s directories to PATH'\n" "${dir_count}"
	else
		printf "# No Bin directories found to add to PATH\n"
	fi
}

initialize_flake() {
	if command -v nix >/dev/null 2>&1; then
		use flake . --no-pure-eval || use nix
	fi
}

#> Initialize the bin scripts
initialize_cache

#> Initialize the flake
initialize_flake
