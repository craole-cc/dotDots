#!/bin/sh

initialize_cache() {
	CACHE_PATH=.direnv/.path_cache
	CACHE_CHECK=false

	if [ -f "$CACHE_PATH" ]; then
		#> Check if any file in Bin is newer than cache
		if ! find Bin -type f -newer "$CACHE_PATH" 2>/dev/null | read -r _; then
			CACHE_CHECK=true
		fi
	fi

	#> Create the cache if it doesn't exist
	case "${CACHE_CHECK:-false}" in false)
		mkdir -p .direnv
		initialize_bin >"$CACHE_PATH"
		;;
	*) ;; esac

	if . "$CACHE_PATH" 2>/dev/null; then
		printf "Warning: direnv cache corrupted, regenerating..." >&2
		CACHE_CHECK=false
	fi
}

#> Ensure Bin scripts are available within the dev shell
initialize_bin() {
	#> Define configuration
	BIN_ROOT="Bin"
	BIN_DEPTH=10
	BIN_IGNORE="review tmp archive"
	DOTS_PATH=""
	dir_count=0

	#> Filter binary directories
	if command -v fd >/dev/null 2>&1; then
		#> Build fd command with multiple --exclude flags dynamically
		fd_cmd="fd --type d --max-depth $((BIN_DEPTH * 2)) . ${BIN_ROOT}"
		for dir in ${BIN_IGNORE}; do
			fd_cmd="${fd_cmd} --exclude ${dir}"
		done
		BIN_DIRS=$(eval "${fd_cmd}")
	else
		#> Fallback to find with grep
		BIN_IGNORE_PATTERN=$(printf "%s" "${BIN_IGNORE}" | tr ' ' '|')
		BIN_DIRS="$(find "${BIN_ROOT}" -maxdepth "${BIN_DEPTH}" -type d 2>/dev/null |
			grep -v -E "(^|/)(${BIN_IGNORE_PATTERN})(/|$)")"
	fi

	#> Add all matching directories to PATH
	for dir in ${BIN_DIRS:-}; do
		#> Skip if directory doesn't exist.
		[ -d "${dir}" ] || continue

		#> Skip if already in PATH
		case ":${PATH}:${DOTS_PATH}:" in ":${dir}:") ;; *)
			# PATH_add "$dir"
			DOTS_PATH="${DOTS_PATH:+"${DOTS_PATH}:"}${dir}"
			dir_count=$((dir_count + 1))
			;;
		esac
	done

	if [ -z "${DOTS_PATH:-}" ]; then :; else
		printf "%s\n" "${DOTS_PATH}" | tr ":" "\n"
		printf "Added %s directories to PATH" "${dir_count:-0}"
	fi
}

initialize_flake() {
	if command -v nix >/dev/null 2>&1; then
		use flake . --no-pure-eval || use nix
	fi
}

#> Initialize the bin scripts
initialize_cache

#> Initialize the flake
initialize_flake
