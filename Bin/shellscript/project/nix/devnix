#!/bin/sh
# shellcheck enable=all

main() {
  trap cleanup EXIT INT TERM
  set_defaults
  parse_arguments "$@"
  access_workspace
  initialize_environment
}

set_defaults() {
  set -eu
  scr_path="$0"
  src_name="$(basename "${scr_path}")"
  initial_dir="${PWD}"
  workspace="${initial_dir}"
  delimiter=" "
  args=""

  weHave_nix="$(command -v nix-shell 2>/dev/null)"
  weHave_flakes="$(nix config show | grep '^experimental-features.*flakes*' 2>/dev/null)"

  tui_editor="${EDITOR:-"$(command -v nano 2>/dev/null)"}"
  gui_editor="${VISUAL:-"${tui_editor}"}"
}

print_error() {
  printf "[ERROR] %s ===" "${src_name}"
  case "$1" in
  --arg)
    shift
    printf "%s requires a value" "$*"
    ;;
  *)
    printf "%s" "$*"
    ;;
  esac
}

print_debug() {
  printf "[DEBUG] %s === %s" "${src_name}" "$*"
}

parse_arguments() {
  while [ "$#" -ge 1 ]; do
    case "$1" in
    --dir)
      if [ -n "$2" ]; then
        workspace="$2"
        shift
      else
        print_error --arg "$1"
      fi
      ;;
    --arg*)
      if [ -n "$2" ]; then
        workspace="$2"
        shift
      else
        print_error --arg "$1"
      fi
      ;;
    *)
      if [ -z "${workspace}" ]; then
        workspace="$1"
      else
        args="${args}${args:+${delimiter}}${1}"
      fi
      ;;
    esac
    shift
  done
}

cdto() {
  case "${PWD}" in "$1") return 0 ;; *)
    if \cd "${1}"; then
      print_debug "Entered directory" "$1"
    else
      print_error "Failed to enter directory:" "${1}"
      exit 1
    fi
    ;;
  esac
}

access_workspace() {
  [ -n "${workspace}" ] || {
    print_error "Workspace path not defined."
    exit 1
  }
  [ -d "${workspace}" ] || {
    print_error "Workspace path not a valid directory." "${workspace}"
    exit 1
  }
  [ -w "${workspace}" ] || {
    print_error "Workspace is not accessible." "${workspace}"
    exit 1
  }

  cdto "${workspace}"
}

initialize_environment() {
  if [ -n "${weHave_flakes}" ] && [ -f "flake.nix" ]; then
    nix develop

  # nix develop --command bash -c "Terminal -- bash -c 'eval $editor $workspace; exec bash'"
  # nix develop --command bash -c "eval $editor $workspace"
  elif [ -n "${weHave_nix}" ] && [ -f "shell.nix" ]; then
    nix shell
  else
    if [ -n "${DISPLAY}" ]; then
      [ -n "${gui_editor}" ] && "${gui_editor}" "${PWD}"
    else
      [ -n "${tui_editor}" ] && "${tui_editor}" "${PWD}"
    fi
  fi
}

cleanup() {
  cdto "${initial_dir}"
}

#@ Execute the final command
main "$@"
