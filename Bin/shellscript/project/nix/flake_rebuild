#! /bin/sh
# shellcheck enable=all

#@ Set defaults
msg="Flake Update"
flake_root="${DOTS:-"$(pwd -P)"}"
build_target="$(hostname)"

#@ Parse arguments
while [ "$#" -gt 0 ]; do
  case "$1" in
  --flake)
    if [ -n "$2" ]; then
      flake_root="$2"
      shift
    else
      exit 1
    fi
    ;;
  --host | --target)
    if [ -n "$2" ]; then
      build_target="$2"
      shift
    else
      exit 1
    fi
    ;;
  *)
    if [ -d "${flake_root}" ]; then
      msg="$1"
    else
      flake_root="$1"
    fi
    ;;
  esac
  shift
done

#@ Navigate to the directory where the flake is located
[ -f "${flake_root}/flake.nix" ] || exit 1
cd "${flake_root}" || exit 1

#@ Check git status and encourage commit, fail if there are changes
if git diff-index --quiet HEAD; then
# git add --all
# git commit --message "${msg}"
printf "Flake is clean\n"

#@ Rebuild NixOS configuration using flakes
sudo nixos-rebuild switch --flake "${flake_root}"#"${build_target}" --upgrade --show-trace
